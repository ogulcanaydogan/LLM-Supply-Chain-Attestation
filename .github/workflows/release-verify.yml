name: release-verify

on:
  release:
    types: [published]
  workflow_run:
    workflows: ["release"]
    types: [completed]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to verify (for example v0.1.0-rc2)"
        required: true
        type: string

permissions:
  contents: read

jobs:
  verify-release-assets:
    if: |
      github.event_name != 'workflow_run' ||
      (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push')
    runs-on: ubuntu-latest
    steps:
      - name: Resolve tag
        id: resolve
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            tag="${{ inputs.tag }}"
          elif [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            tag="${{ github.event.workflow_run.head_branch }}"
            if [[ -z "${tag}" ]]; then
              tag="$(gh api "/repos/${GITHUB_REPOSITORY}/releases?per_page=100" \
                --jq '.[] | select(.target_commitish == "${{ github.event.workflow_run.head_sha }}") | .tag_name' | head -n1)"
            fi
          else
            tag="${{ github.event.release.tag_name }}"
          fi
          if [[ -z "${tag}" ]]; then
            echo "missing release tag"
            exit 1
          fi
          echo "tag=${tag}" >> "${GITHUB_OUTPUT}"

      - name: Setup cosign
        uses: sigstore/cosign-installer@v3

      - name: Download release assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p release-assets
          gh release download "${{ steps.resolve.outputs.tag }}" \
            -R "${GITHUB_REPOSITORY}" \
            -D release-assets
          ls -la release-assets

      - name: Verify checksums
        run: |
          cd release-assets
          if [[ ! -f checksums.txt ]]; then
            echo "checksums.txt not found in release assets"
            exit 1
          fi
          sha256sum -c checksums.txt

      - name: Verify cosign signatures
        run: |
          cd release-assets
          identity_re="^https://github\\.com/${GITHUB_REPOSITORY}/.github/workflows/release\\.yml@refs/tags/.+$"
          for artifact in *; do
            case "${artifact}" in
              *.sig|*.pem)
                continue
                ;;
            esac
            if [[ ! -f "${artifact}.sig" ]]; then
              echo "missing signature for ${artifact}"
              exit 1
            fi
            if [[ ! -f "${artifact}.pem" ]]; then
              echo "missing certificate for ${artifact}"
              exit 1
            fi
            cosign verify-blob \
              --signature "${artifact}.sig" \
              --certificate "${artifact}.pem" \
              --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
              --certificate-identity-regexp "${identity_re}" \
              "${artifact}" >/dev/null
          done
