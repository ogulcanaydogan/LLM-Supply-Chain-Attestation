name: ci-attest-verify

on:
  pull_request:
  push:
    branches: [main]

jobs:
  attestation-gate:
    name: attestation-gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Test
        run: go test ./...

      - name: Init
        run: go run ./cmd/llmsa init

      - name: Create attestations
        run: |
          mkdir -p .llmsa/attestations
          go run ./cmd/llmsa attest create --type prompt_attestation --config examples/tiny-rag/configs/prompt.yaml --out .llmsa/attestations
          go run ./cmd/llmsa attest create --type corpus_attestation --config examples/tiny-rag/configs/corpus.yaml --out .llmsa/attestations
          go run ./cmd/llmsa attest create --type eval_attestation --config examples/tiny-rag/configs/eval.yaml --out .llmsa/attestations
          go run ./cmd/llmsa attest create --type route_attestation --config examples/tiny-rag/configs/route.yaml --out .llmsa/attestations
          go run ./cmd/llmsa attest create --type slo_attestation --config examples/tiny-rag/configs/slo.yaml --out .llmsa/attestations

      - name: Sign bundles
        run: |
          for s in .llmsa/attestations/statement_*.json; do
            b="${s%.json}.bundle.json"
            go run ./cmd/llmsa sign --in "$s" --provider sigstore --out "$b"
          done

      - name: Verify
        run: |
          go run ./cmd/llmsa verify \
            --source local \
            --attestations .llmsa/attestations \
            --policy policy/examples/mvp-gates.yaml \
            --format json \
            --out verify.json
          go run ./cmd/llmsa report --in verify.json --out verify.md

      - name: Gate
        run: |
          REF=origin/main
          git rev-parse --verify "$REF" >/dev/null 2>&1 || REF=HEAD~1
          go run ./cmd/llmsa gate \
            --policy policy/examples/mvp-gates.yaml \
            --attestations .llmsa/attestations \
            --git-ref "$REF"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: llmsa-verify-artifacts
          path: |
            .llmsa/attestations/*.bundle.json
            verify.json
            verify.md
