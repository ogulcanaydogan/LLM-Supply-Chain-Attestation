name: ci-attest-verify

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read
  id-token: write
  packages: write

jobs:
  attestation-gate:
    name: attestation-gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Setup cosign
        uses: sigstore/cosign-installer@v3

      - name: Test
        run: go test ./...

      - name: Init
        run: go run ./cmd/llmsa init

      - name: Create attestations
        run: |
          mkdir -p .llmsa/attestations
          go run ./cmd/llmsa attest create --type prompt_attestation --config examples/tiny-rag/configs/prompt.yaml --out .llmsa/attestations
          go run ./cmd/llmsa attest create --type corpus_attestation --config examples/tiny-rag/configs/corpus.yaml --out .llmsa/attestations
          go run ./cmd/llmsa attest create --type eval_attestation --config examples/tiny-rag/configs/eval.yaml --out .llmsa/attestations
          go run ./cmd/llmsa attest create --type route_attestation --config examples/tiny-rag/configs/route.yaml --out .llmsa/attestations
          go run ./cmd/llmsa attest create --type slo_attestation --config examples/tiny-rag/configs/slo.yaml --out .llmsa/attestations

      - name: Sign bundles
        run: |
          for s in .llmsa/attestations/statement_*.json; do
            go run ./cmd/llmsa sign --in "$s" --provider sigstore --out .llmsa/attestations
          done

      - name: Login to GHCR
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish bundles to OCI
        if: github.event_name == 'push'
        run: |
          REPO_LOWER="$(echo "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')"
          : > oci-refs.txt
          n=0
          for b in .llmsa/attestations/*.bundle.json; do
            n=$((n+1))
            ref="ghcr.io/${REPO_LOWER}/attestations:${GITHUB_SHA}-b${n}"
            pinned="$(go run ./cmd/llmsa publish --in "$b" --oci "$ref" | tail -n1)"
            echo "$pinned" >> oci-refs.txt
          done

      - name: Verify from OCI
        if: github.event_name == 'push'
        run: |
          OCI_REFS="$(paste -sd, oci-refs.txt)"
          go run ./cmd/llmsa verify \
            --source oci \
            --attestations "$OCI_REFS" \
            --policy policy/examples/mvp-gates.yaml \
            --format json \
            --out verify-oci.json

      - name: Gate from OCI
        if: github.event_name == 'push'
        run: |
          OCI_REFS="$(paste -sd, oci-refs.txt)"
          REF=origin/main
          git rev-parse --verify "$REF" >/dev/null 2>&1 || REF=HEAD~1
          go run ./cmd/llmsa gate \
            --source oci \
            --policy policy/examples/mvp-gates.yaml \
            --attestations "$OCI_REFS" \
            --git-ref "$REF"

      - name: Verify
        run: |
          go run ./cmd/llmsa verify \
            --source local \
            --attestations .llmsa/attestations \
            --policy policy/examples/mvp-gates.yaml \
            --format json \
            --out verify.json
          go run ./cmd/llmsa report --in verify.json --out verify.md

      - name: Gate
        run: |
          REF=origin/main
          git rev-parse --verify "$REF" >/dev/null 2>&1 || REF=HEAD~1
          go run ./cmd/llmsa gate \
            --policy policy/examples/mvp-gates.yaml \
            --attestations .llmsa/attestations \
            --git-ref "$REF"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: llmsa-verify-artifacts
          path: |
            .llmsa/attestations/*.bundle.json
            oci-refs.txt
            verify.json
            verify-oci.json
            verify.md
