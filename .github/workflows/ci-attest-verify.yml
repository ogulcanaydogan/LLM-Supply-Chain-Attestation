name: ci-attest-verify

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read
  id-token: write
  packages: write

concurrency:
  group: ci-attest-verify-${{ github.ref }}
  cancel-in-progress: true

jobs:
  attestation-gate:
    name: attestation-gate
    runs-on: ubuntu-latest
    timeout-minutes: 35
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Setup cosign
        uses: sigstore/cosign-installer@v3

      - name: Test
        run: go test ./...

      - name: E2E Tests
        run: go test -tags=e2e -v -timeout 120s ./test/e2e/

      - name: Init
        run: go run ./cmd/llmsa init

      - name: Preflight checks
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          test -f policy/examples/mvp-gates.yaml
          test -d examples/tiny-rag/configs
          if [[ "${{ github.event_name }}" == "push" ]]; then
            test -n "${GITHUB_TOKEN}"
          fi

      - name: Create attestations
        run: |
          rm -rf .llmsa/attestations
          mkdir -p .llmsa/attestations
          go run ./cmd/llmsa attest create --type prompt_attestation --config examples/tiny-rag/configs/prompt.yaml --out .llmsa/attestations
          go run ./cmd/llmsa attest create --type corpus_attestation --config examples/tiny-rag/configs/corpus.yaml --out .llmsa/attestations
          go run ./cmd/llmsa attest create --type eval_attestation --config examples/tiny-rag/configs/eval.yaml --out .llmsa/attestations
          go run ./cmd/llmsa attest create --type route_attestation --config examples/tiny-rag/configs/route.yaml --out .llmsa/attestations
          go run ./cmd/llmsa attest create --type slo_attestation --config examples/tiny-rag/configs/slo.yaml --out .llmsa/attestations

      - name: Sign bundles
        run: |
          for s in .llmsa/attestations/statement_*.json; do
            go run ./cmd/llmsa sign --in "$s" --provider sigstore --out .llmsa/attestations
          done

      - name: Login to GHCR
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish bundles to OCI
        if: github.event_name == 'push'
        run: |
          REPO_LOWER="$(echo "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')"
          : > oci-refs.txt
          n=0
          for b in .llmsa/attestations/*.bundle.json; do
            n=$((n+1))
            ref="ghcr.io/${REPO_LOWER}/attestations:${GITHUB_SHA}-b${n}"
            pinned=""
            for attempt in 1 2 3; do
              if pinned="$(go run ./cmd/llmsa publish --in "$b" --oci "$ref" | tail -n1)"; then
                break
              fi
              sleep $((attempt * 5))
            done
            if [[ -z "${pinned}" ]]; then
              echo "failed to publish ${b} after retries"
              exit 1
            fi
            echo "$pinned" >> oci-refs.txt
          done
          wc -l oci-refs.txt

      - name: Verify from OCI
        if: github.event_name == 'push'
        run: |
          OCI_REFS="$(paste -sd, oci-refs.txt)"
          ok=0
          for attempt in 1 2 3; do
            if go run ./cmd/llmsa verify \
              --source oci \
              --attestations "$OCI_REFS" \
              --policy policy/examples/mvp-gates.yaml \
              --format json \
              --out verify-oci.json; then
              ok=1
              break
            fi
            sleep $((attempt * 10))
          done
          if [[ "${ok}" != "1" ]]; then
            echo "OCI verification failed after retries"
            if [[ -f verify-oci.json ]]; then
              cat verify-oci.json
            fi
            exit 1
          fi

      - name: Gate from OCI
        if: github.event_name == 'push'
        run: |
          OCI_REFS="$(paste -sd, oci-refs.txt)"
          REF=origin/main
          git rev-parse --verify "$REF" >/dev/null 2>&1 || REF=HEAD~1
          go run ./cmd/llmsa gate \
            --source oci \
            --policy policy/examples/mvp-gates.yaml \
            --attestations "$OCI_REFS" \
            --git-ref "$REF"

      - name: Verify
        run: |
          go run ./cmd/llmsa verify \
            --source local \
            --attestations .llmsa/attestations \
            --policy policy/examples/mvp-gates.yaml \
            --format json \
            --out verify.json
          go run ./cmd/llmsa report --in verify.json --out verify.md

      - name: Gate
        run: |
          REF=origin/main
          git rev-parse --verify "$REF" >/dev/null 2>&1 || REF=HEAD~1
          go run ./cmd/llmsa gate \
            --policy policy/examples/mvp-gates.yaml \
            --attestations .llmsa/attestations \
            --git-ref "$REF"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: llmsa-verify-artifacts
          path: |
            .llmsa/attestations/*.bundle.json
            oci-refs.txt
            verify.json
            verify-oci.json
            verify.md
